---
title: "Meade 4000 Filter"
author: "Ralph Rogge (RRO)"
date: "17. Februar 2016"
output:
    html_document:
        fig_width: 10
        fig_height: 6
---

Set this flag to TRUE when you want to write out plots.
```{r}
write.plot.enabled = F
```

```{r, message=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
```

Filter names
```{r}
filter.names <- c("8"  , "11" ,  "21", 
                  "23A", "25A", "38A", 
                  "47" , "56" , "58" , 
                  "80A", "82A")
```

Filter colors
```{r}
filter.colors <- c("yellow",       "yellowgreen", "orange",
                   "red",          "red3",        "blue",
                   "purple",       "green",       "green3",
                   "deepskyblue3", "skyblue",     "black")

```

Filter labels
```{r}
filter.labels <- c("#8",   "#11",  "#21",
                   "#23A", "#25A", "#38A",
                   "#47",  "#56",  "#58",
                   "#80A", "#82A", "None")

```

Filter wavelength range
```{r}
filter.wavelength.delta <- 1
filter.wavelength <- seq(200, 900, filter.wavelength.delta)
```

Function to read in filter data
```{r}
read.filter <- function(name) {
  read.csv(name, col.names=c("wavelength","transmission","X"))[,1:2]
}
```

Function to preprocess filter data
```{r}
preprocess <- function(df, wavelength, name) {
  t <- approx(df$wavelength, df$transmission, wavelength)$y
  data.frame(wavelength=wavelength, transmission=t, name=name)
}
```

Read Meade 4000 filter set data from files
```{r}
filter <- data.frame(wavelength=c(), transmission=c(), name=c())
for (name in filter.names) {
  filename <- paste0("Meade 4000 Filter ",name,".csv")
  filter <- rbind(filter, preprocess(read.filter(filename), filter.wavelength, name))
}
```

Function used to write plot to PNG file
```{r}
write.plot <- function(p, filename, width=1024, height=576, font.size=16) {
  png(filename,width, height)
  print(p + theme_bw(base_size=font.size))
  dev.off()
}
```

Plot transmission of Meade 4000 filters
```{r}
p <- ggplot(data=filter) +
  geom_line(aes(wavelength,transmission,color=factor(name, levels=c(filter.names, "None")))) +
  scale_colour_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  labs(title="Meade 4000 Filter", x="Wavelength [nm]", y="Transmission [%]") +
  theme_bw() +
  coord_cartesian(xlim=c(250,800))
p

if (write.plot.enabled) write.plot(p, "Meade 4000 Filter.png")
```

Function to read vision data from file
```{r}
read.vision <- function(filename, type) {
  df <- read.csv(filename)
  df$type <- type
  df
}
```

Read data for scotopic and photopic vision from file
```{r}
vision <- read.vision("scvle.csv", "Scotopic")
vision <- rbind(vision, read.vision("vljve.csv", "Photopic"))
```

Wavelength limits for plots
```{r}
w.min <- max(min(vision$wavelength), 380)
w.max <- min(max(vision$wavelength), 720)
```

Plot relative luminous efficency of photopic and scotopic visions
```{r}
p <- ggplot(data=vision) +
  geom_line(aes(wavelength,rle,color=factor(type,levels=c("Scotopic", "Photopic")))) +
  scale_color_manual(name="Vision", values=c("black","grey70")) +
  labs(title="Photopic and Scotopic Vision", 
       x="Wavelength [nm]", 
       y="Relative Luminous Efficiency") +
  coord_cartesian(xlim=c(w.min,w.max)) +
  theme_bw()
p

if (write.plot.enabled) write.plot(p, "Photopic and Scotopic Vision.png")
```

Read solar spectral distribution from file
```{r}
sun <- read.csv("ASTMG173.csv", header=F, skip=2)[,c(1,3)]
colnames(sun) <- c("wavelength","irradiance")
```

Plot solar spectral distribution
```{r}
p <- ggplot(data=sun) +
  geom_line(aes(wavelength,irradiance)) +
  labs(title="Solar Spectral Irradiance / Air Mass 1.5",
       x="Wavelength [nm]",
       y="Irradiance [W/m^2/nm]") +
  theme_bw() +
  coord_cartesian(xlim=c(w.min,w.max))
p
```

Plot of filtered luminous efficiency for scotopic vision with Meade 4000 filter applied
```{r}
# Select scotopic vision data.
scotopic.vision <- subset(vision, type=="Scotopic")

# Create data frame with wavelength, transmission, and filter.
scotopic.data <- data.frame(wavelength = filter$wavelength, 
                            transmission = filter$transmission, 
                            filter = filter$name)

# Add plain vision data.
scotopic.data <- rbind(scotopic.data, data.frame(wavelength = filter.wavelength,
                                                 transmission = 100, 
                                                 filter = "None"))

# Add relative luminous efficiency.
scotopic.data$rle <- approx(scotopic.vision$wavelength, 
                            scotopic.vision$rle, 
                            filter.wavelength, 
                            yleft=0, 
                            yright=0)$y

# Add filtered luminous efficiency
scotopic.data$fle <- scotopic.data$rle * scotopic.data$transmission/100 

# Add solar spectral irrandiance
scotopic.data$irradiance <- approx(sun$wavelength, 
                            sun$irradiance, 
                            filter.wavelength,
                            rule=2)$y

# Add vision.
scotopic.data$vision <- "Scotopic"

p <- ggplot(data=scotopic.data) +
  geom_line(aes(wavelength, fle, color=factor(filter, levels=c(filter.names, "None")))) +
  scale_colour_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  labs(title="Scotopic Vision / Meade 4000 Filter",
       x="Wavelength [nm]",
       y="Filtered Luminous Efficiency") +
  theme_bw() +
  coord_cartesian(xlim=c(w.min,w.max))
p

if (write.plot.enabled) write.plot(p, "Scotopic Vision and Meade 4000 Filter.png")
```

Flux for scotopic visions with Meade 4000 filter applied
```{r}
scotopic.k.m <- 1699

scotopic.flux <- scotopic.data %>%
  group_by(filter) %>%
  summarize(flux=scotopic.k.m * sum(rle * transmission / 100 *irradiance) * filter.wavelength.delta) %>%
  arrange(-flux) %>%
  mutate(vision="Scotopic")
print(data.table(scotopic.flux))
```

Plot flux for scotopic visions with Meade 4000 filter applied
```{r}
p <- ggplot(scotopic.flux) +
  geom_bar(aes(x=filter,y=flux,fill=factor(filter, levels=c(filter.names, "None"))),stat="identity") +
  scale_fill_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  labs(title="Flux / Scotopic Vision / Meade 4000 Filter",
       x="Wavelength [nm]",
       y="Flux [lm/W]") +
  theme_bw()
p

if (write.plot.enabled) write.plot(p, "Flux for Scotopic Vision with Meade 4000 Filter.png")
```


Plot of filtered luminous efficiency for photopic vision with Meade 4000 filter applied
```{r}
# Select photopic vision data.
photopic.vision <- subset(vision, type=="Photopic")

# Create data frame with wavelength, transmission, filter, and vision.
photopic.data <- data.frame(wavelength = filter$wavelength, 
                            transmission = filter$transmission, 
                            filter = filter$name)

# Add plain vision data.
photopic.data <- rbind(photopic.data, data.frame(wavelength = filter.wavelength,
                                                 transmission = 100, 
                                                 filter = "None"))

# Add relative luminous efficiency.
photopic.data$rle <- approx(photopic.vision$wavelength, 
                            photopic.vision$rle, 
                            filter.wavelength, 
                            yleft=0, 
                            yright=0)$y

# Add filtered luminous efficiency
photopic.data$fle <- photopic.data$rle * photopic.data$transmission/100 

# Add solar spectral irrandiance
photopic.data$irradiance <- approx(sun$wavelength, 
                            sun$irradiance, 
                            filter.wavelength,
                            rule=2)$y

# Add vision.
photopic.data$vision <- "Photopic"

p <- ggplot(data=photopic.data) +
  geom_line(aes(wavelength, fle, color=factor(filter, levels=c(filter.names, "None")))) +
  scale_colour_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  labs(title="Photopic Vision / Meade 4000 Filter",
       x="Wavelength [nm]",
       y="Filtered Luminous Efficiency") +
  theme_bw() +
  coord_cartesian(xlim=c(w.min,w.max))
p

if (write.plot.enabled) write.plot(p, "Photopic Vision and Meade 4000 Filter.png")
```

Flux for photopic visions with Meade 4000 filter applied
```{r}
photopic.k.m <- 683

photopic.flux <- photopic.data %>%
  group_by(filter) %>%
  summarize(flux=683 * sum(rle * transmission / 100 * irradiance) * filter.wavelength.delta) %>%
  arrange(-flux) %>%
  mutate(vision="Photopic")
print(data.table(photopic.flux))
```

Plot flux for photopic visions with Meade 4000 filter applied
```{r}
p <- ggplot(photopic.flux) +
  geom_bar(aes(x=filter,y=flux,fill=factor(filter, levels=c(filter.names, "None"))),stat="identity") +
  scale_fill_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  labs(title="Flux / Photopic Vision / Meade 4000 Filter",
       x="Wavelength [nm]",
       y="Flux [lm/W]") +
  theme_bw()
p

if (write.plot.enabled) write.plot(p, "Flux for Photopic Vision with Meade 4000 Filter.png")
```

Combine scotopic and photopic data
```{r}
combined.data <- scotopic.data
combined.data <- rbind(combined.data, photopic.data)
combined.data$vision <- factor(combined.data$vision, levels=c("Scotopic", "Photopic"))
```

Plot combined scotopic and photopic data
```{r}
p <- ggplot(data=combined.data) +
  geom_line(aes(wavelength, fle, color=factor(filter, levels=c(filter.names, "None")))) +
  facet_grid(. ~ vision) +
  scale_colour_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  labs(title="Vision / Meade 4000 Filter",
       x="Wavelength [nm]",
       y="Filtered Luminous Efficiency") +
  theme_bw() +
  coord_cartesian(xlim=c(w.min,w.max))
p

if (write.plot.enabled) write.plot(p, "Vision and Meade 4000 Filter.png")
```

Combine scotopic and photopic flux
```{r}
combined.flux <- scotopic.flux
combined.flux <- rbind(combined.flux, photopic.flux)
combined.flux$vision <- factor(combined.flux$vision, levels=c("Scotopic", "Photopic"))
```

Plot of combined scotopic and photopic flux
```{r}
p <- ggplot(combined.flux) +
  geom_bar(aes(x=filter,y=flux,fill=factor(filter, levels=c(filter.names, "None"))),stat="identity") +
  scale_fill_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  facet_grid(. ~ vision) +
  labs(title="Flux / Meade 4000 Filter",
       x="Wavelength [nm]",
       y="Flux [lm/W]") +
  theme_bw()
p

if (write.plot.enabled) write.plot(p, "Flux with Meade 4000 Filter.png")
```