---
title: "Meade 4000 Filter"
author: "Ralph Rogge (RRO)"
date: "17. Februar 2016"
output:
    html_document:
        fig_width: 10
        fig_height: 6
---

Set this flag to TRUE when you want to write out plots.
```{r}
write.plot.enabled = F
```

```{r, message=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
library(jsonlite)
```

Filter names
```{r}
filter.names <- c("8"  , "11" ,  "21", 
                  "23A", "25A", "38A", 
                  "47" , "56" , "58" , 
                  "80A", "82A")
```

Filter colors
```{r}
filter.colors <- c("yellow",       "yellowgreen", "orange",
                   "red",          "red3",        "blue",
                   "purple",       "green",       "green3",
                   "deepskyblue3", "skyblue",     "black")

```

Filter labels
```{r}
filter.labels <- c("#8",   "#11",  "#21",
                   "#23A", "#25A", "#38A",
                   "#47",  "#56",  "#58",
                   "#80A", "#82A", "None")

```

Filter wavelength range
```{r}
filter.wavelength.delta <- 1
filter.wavelength <- seq(200, 900, filter.wavelength.delta)
```

Function to read in filter data
```{r}
read.filter <- function(name) {
  read.csv(name, col.names=c("wavelength","transmission","X"))[,1:2]
}
```

Function to preprocess filter data
```{r}
preprocess <- function(df, wavelength, name) {
  t <- approx(df$wavelength, df$transmission, wavelength)$y
  data.frame(wavelength=wavelength, transmission=t, name=name)
}
```

Read Meade 4000 filter set data from files
```{r}
filter <- data.frame(wavelength=c(), transmission=c(), name=c())
for (name in filter.names) {
  filename <- paste0("Meade 4000 Filter ",name,".csv")
  filter <- rbind(filter, preprocess(read.filter(filename), filter.wavelength, name))
}
```

Function used to write plot to PNG file
```{r}
write.plot <- function(p, filename, width=1024, height=576, font.size=16) {
  png(filename,width, height)
  print(p + theme_bw(base_size=font.size))
  dev.off()
}
```

Plot transmission of Meade 4000 filters
```{r}
p <- ggplot(data=filter) +
  geom_line(aes(wavelength,transmission,color=factor(name, levels=c(filter.names, "None")))) +
  scale_colour_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  labs(title="Meade 4000 Filter", x="Wavelength [nm]", y="Transmission [%]") +
  theme_bw() +
  coord_cartesian(xlim=c(250,800))
p

if (write.plot.enabled) write.plot(p, "Meade 4000 Filter.png")
```

Function to read vision data from file
```{r}
read.vision <- function(filename, type) {
  df <- read.csv(filename)
  df$type <- type
  df
}
```

Read data for scotopic and photopic vision from file
```{r}
vision <- rbind(read.vision("scvle.csv", "Scotopic"), read.vision("vljve.csv", "Photopic"))
vision$type = factor(vision$type, levels=c("Scotopic", "Photopic")) # Reorder vision type
```

Wavelength limits for plots
```{r}
w.min <- max(min(vision$wavelength), 380)
w.max <- min(max(vision$wavelength), 720)
w.range <- seq(w.min, w.max)
```

Plot relative luminous efficency of photopic and scotopic visions
```{r}
p <- ggplot(data=vision) +
  geom_line(aes(wavelength,rle,color=type)) +
  scale_color_manual(name="Vision", values=c("black","grey70")) +
  labs(title="Photopic and Scotopic Vision", 
       x="Wavelength [nm]", 
       y="Relative Luminous Efficiency") +
  coord_cartesian(xlim=c(w.min,w.max)) +
  theme_bw()
p

if (write.plot.enabled) write.plot(p, "Photopic and Scotopic Vision.png")
```

## Visual Observing of Sunlight

Read solar spectral distribution from file
```{r}
sun <- read.csv("ASTMG173.csv", header=F, skip=2)[,c(1,3)]
colnames(sun) <- c("wavelength","irradiance")
```

Plot solar spectral distribution
```{r}
p <- ggplot(data=sun) +
  geom_line(aes(wavelength,irradiance)) +
  labs(title="Solar Spectral Irradiance / Air Mass 1.5",
       x="Wavelength [nm]",
       y="Irradiance [W/m^2/nm]") +
  theme_bw() +
  coord_cartesian(xlim=c(w.min,w.max))
p
```

Function to set up data frame for visual observing of Sun
```{r}
sun.setup <- function(filter, vision, vision.type, sun) {
  
  subvision <- subset(vision, type==vision.type)

  # Create data frame with wavelength, transmission, filter.
  df <- data.frame(wavelength = filter$wavelength, 
                   transmission = filter$transmission, 
                   filter = filter$name)

  # Add plain vision data.
  df <- rbind(df, data.frame(wavelength = seq(min(filter$wavelength), max(filter$wavelength)),
                             transmission = 100, 
                             filter = "None"))

  # Add relative luminous efficiency.
  df$rle <- approx(subvision$wavelength, 
                   subvision$rle, 
                   df$wavelength, 
                   rule=2)$y

  # Add filtered luminous efficiency
  df$fle <- df$rle * df$transmission/100 

  # Add solar spectral irrandiance
  df$irradiance <- approx(sun$wavelength, 
                          sun$irradiance, 
                          df$wavelength,
                          rule=2)$y

  # Add vision.
  df$vision <- vision.type

  # Return.
  df
}
```

Visual observing using Meade 4000 filter set
```{r}
sun.visual <- rbind(sun.setup(filter,vision,"Scotopic",sun), sun.setup(filter,vision,"Photopic",sun))
sun.visual$vision <- factor(sun.visual$vision, levels=c("Scotopic","Photopic"))
```

Plot of relative luminous efficiency for visual observing with Meade 4000 filter set
```{r}
p <- ggplot(data=sun.visual) +
  geom_line(aes(wavelength, fle, color=factor(filter, levels=c(filter.names, "None")))) +
  scale_colour_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  facet_grid(. ~ vision) +
  labs(title="Visual Observing with Meade 4000 Filter Set",
       x="Wavelength [nm]",
       y="Relative Luminous Efficiency") +
  theme_bw() +
  coord_cartesian(xlim=c(w.min,w.max))
p

if (write.plot.enabled) write.plot(p, "Visual Observing with Meade 4000 Filter Set.png")
```

Flux for visual observing with Meade 4000 filter set
```{r}
sun.flux <- sun.visual %>%
  
  # Group by vision and filter.
  group_by(vision, filter) %>%
  
  # Add vision specific constant.
  mutate(k = ifelse(vision=="Scotopic",1699,683)) %>%
  
  # Calculate flux.
  summarize(flux=sum(fle*irradiance*k)) %>%
  
  # Sort by flux.
  arrange(-flux)

print(data.table(sun.flux))
```

Plot flux for scotopic visions with Meade 4000 filter applied
```{r}
p <- ggplot(sun.flux) +
  geom_bar(aes(x=filter,y=flux,fill=factor(filter, levels=c(filter.names, "None"))),stat="identity") +
  scale_fill_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  facet_grid(. ~ vision) +
  labs(title="Visual Observing Sunlight / Meade 4000 Filter",
       x="Wavelength [nm]",
       y="Flux [lm/W]") +
  theme_bw()
p

if (write.plot.enabled) write.plot(p, "Visual Observing Sunlight - Meade 4000 Filter.png")
```

## Visual Observing of Jupiter

Read Jupiter NEB/NTrZ reflectance data from file
```{r}
neb <- read.csv("NEB.csv")
ntrz <- read.csv("NTrZ.csv")
```

Plot of Jupiter NEB/NTrZ reflectance
```{r}
p <- ggplot(data=rbind(neb,ntrz)) +
  geom_line(aes(wavelength,100*reflectance,color=feature)) +
  scale_color_discrete(name="Feature") +
  labs(title="Jupiter Reflectance",
       x="Wavelength [nm]",
       y="Reflectance [%]") +
  theme_bw() +
  coord_cartesian(xlim=c(w.min,w.max))
p

if (write.plot.enabled) write.plot(p, "Jupiter NTrZ Reflectance.png")
```

Function to set up data frame for visual observing of Jupiter
```{r}
jupiter.setup <- function(filter, vision, vision.type, neb, ntrz) {
  
  subvision <- subset(vision, type==vision.type)

  # Create data frame with wavelength, transmission, filter.
  df <- data.frame(wavelength = filter$wavelength, 
                   transmission = filter$transmission, 
                   filter = filter$name)
  
  # Add plain vision data.
  df <- rbind(df, data.frame(wavelength = seq(min(df$wavelength), max(df$wavelength)), 
                             transmission = 100, 
                             filter = "None"))
  
  # Add relative luminous efficiency.
  df$rle <- approx(subvision$wavelength, 
                   subvision$rle, 
                   df$wavelength, 
                   rule=2)$y

  # Add filtered luminous efficiency.
  df$fle <- df$rle * df$transmission / 100

  # Add Jupiter NEB reflectance.
  df$neb <- approx(neb$wavelength, 
                   neb$reflectance,
                   df$wavelength,
                   rule=2)$y

  # Add Jupiter NTrZ reflectance.
  df$ntrz <- approx(ntrz$wavelength, 
                    ntrz$reflectance,
                    df$wavelength,
                    rule=2)$y

  # Add vision.
  df$vision <- vision.type

  df
}
```

Combine Jupiter visual data for scotopic and photopic vision
```{r}
jupiter.visual <- rbind(
  jupiter.setup(filter, vision, "Scotopic", neb, ntrz), 
  jupiter.setup(filter, vision, "Photopic", neb, ntrz)
)
```

Flux and contrast for visual observing Jupiter with Meade 4000 filter set
```{r}
jupiter.flux <- jupiter.visual %>%
  
  # Adjust vision order.
  mutate(vision=factor(vision, levels=c("Scotopic","Photopic"))) %>%
  
    # Add vision specific constant.
  mutate(k = ifelse(vision=="Scotopic",1699,683)) %>%

  # Group by vision and filter.
  group_by(vision, filter) %>%
  
  # Calculate flux.
  summarize(flux.neb=sum(k*fle*neb), flux.ntrz=sum(k*fle*ntrz)) %>%
  
  # Calculate Michelson contrast.
  mutate(michelson=(flux.ntrz-flux.neb)/(flux.ntrz+flux.neb)) %>%
  
  # Calculate Weber contrast.
  mutate(weber=(flux.ntrz-flux.neb)/(flux.ntrz)) %>%
  
  # Sort by contrast.
  arrange(-michelson)

print(data.table(jupiter.flux))
```

Plot flux and contrast for visual observing Jupiter with Meade 4000 filter set
```{r}
p <- ggplot(jupiter.flux) +
  geom_bar(aes(x=filter,y=michelson,fill=factor(filter, levels=c(filter.names, "None"))),stat="identity") +
  scale_fill_manual(name="Filter", values=filter.colors, labels=filter.labels) +
  facet_grid(. ~ vision) +
  labs(title="Jupiter NEB/NTrz Contrast",
       x="Wavelength [nm]",
       y="Contrast") +
  theme_bw()
p

if (write.plot.enabled) write.plot(p, "Jupiter NEB NTrZ Contrast.png")
```

